pipeline {
    agent { label 'agent-linux' }

    environment {
        AZURE_CREDS = credentials('AZURE_CREDENTIALS')  // Azure credentials stored in Jenkins
    }

    parameters {
        string(name: 'VM_NAME', defaultValue: 'MyVM', description: 'Name of the VM')
        string(name: 'VM_SIZE', defaultValue: 'Standard_B1ms', description: 'Size of the VM')
        string(name: 'ADMIN_USERNAME', defaultValue: 'adminuser', description: 'Admin username for the VM')
        string(name: 'ADMIN_PASSWORD', defaultValue: '', description: 'Admin password for the VM')
        string(name: 'RESOURCE_GROUP', defaultValue: 'rg-admin-001', description: 'Resource Group Name')
        string(name: 'LOCATION', defaultValue: 'Central India', description: 'Location for the VM')
        string(name: 'VM_IMAGE', defaultValue: 'Canonical:UbuntuServer:20.04-LTS:latest', description: 'VM Image in the format Publisher:Offer:Sku:Version')
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Login to Azure') {
            steps {
                pwsh '''
                    # Set the Azure credentials environment variable
                    $env:AZURE_CREDS_JSON = $env:AZURE_CREDS

                    # Use absolute path to the script
                    $scriptPath = "${env.WORKSPACE}powershell_scripts/login.ps1"

                    # Check if the script exists
                    if (Test-Path $scriptPath) {
                        Write-Host "Found login.ps1 at: $scriptPath"
                        & $scriptPath
                    } else {
                        Write-Host "login.ps1 not found at: $scriptPath"
                        exit 1
                    }
                '''
            }
        }

        stage('Create VM') {
            steps {
                pwsh '''
                    # Define the parameters from Jenkins environment
                    $vmName = "${params.VM_NAME}"
                    $vmSize = "${params.VM_SIZE}"
                    $adminUsername = "${params.ADMIN_USERNAME}"
                    $adminPassword = "${params.ADMIN_PASSWORD}"
                    $resourceGroupName = "${params.RESOURCE_GROUP}"
                    $location = "${params.LOCATION}"
                    $vmImage = "${params.VM_IMAGE}"

                    # Path to the PowerShell script for VM creation
                    $scriptPath = "${env.WORKSPACE}create-vm/create-vm.ps1"

                    # Check if the script exists
                    if (Test-Path $scriptPath) {
                        Write-Host "Found create-vm.ps1 at: $scriptPath"
                        & $scriptPath -vmName $vmName -vmSize $vmSize -adminUsername $adminUsername `
                            -adminPassword $adminPassword -resourceGroupName $resourceGroupName `
                            -location $location -vmImage $vmImage
                    } else {
                        Write-Host "create-vm.ps1 not found at: $scriptPath"
                        exit 1
                    }
                '''
            }
        }
    }
}
